<!doctype html> 
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Taiwan Pride ğŸŒˆï½œ11Ã—11 æ’æ¡Œè¡¨ï¼ˆLeader Dock + Popoverï¼‰</title>
<style>
  :root{
    --bg:#0A0B0F; --card:#10131A; --muted:#9AA4AF; --fg:#F2F5F8; --border:#1f2430;
    --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    --rainbow: linear-gradient(90deg,#ff5f6d,#ffc371,#9be15d,#00e3ae,#45aaf2,#9b59b6);
    --btn-grad: linear-gradient(90deg,#7dd3fc,#86efac);
    --colw: 100px;   /* å¯èª¿æ¬„å¯¬ï¼š30â€“250px */
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:"Noto Sans TC","PingFang TC","Microsoft JhengHei",ui-sans-serif,system-ui;
    background: radial-gradient(800px 600px at 10% -10%, rgba(255,255,255,.06), transparent), var(--bg);
    color:var(--fg);
  }
  .wrap{max-width:1200px;margin:24px auto 80px;padding:0 14px}
  .h{font-size:22px;font-weight:900;letter-spacing:.2px}
  .sub{font-size:13px;color:var(--muted)}
  .bar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin:10px 0 14px}
  .btn{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#0f1117;color:#e5e7eb;font-weight:800;cursor:pointer}
  .btn.primary{border:0;background:var(--btn-grad);color:#0b0c10}
  .btn.ghost{background:transparent}
  .btn.toggle[aria-pressed="true"]{outline:2px solid #93c5fd}

  /* ===== Leader Dockï¼ˆä¸Šæ–¹ï¼‰ ===== */
  .dock{position:sticky;top:0;z-index:10;padding:10px;border:1px solid var(--border);border-radius:14px;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));box-shadow:0 6px 24px rgba(0,0,0,.35)}
  .dock-title{display:flex;align-items:center;gap:10px;margin-bottom:6px}
  .dock-body{display:flex;flex-wrap:wrap;gap:8px;min-height:46px;border:1px dashed #2b3244;padding:8px;border-radius:10px}
  .dock-body.drop-hover{outline:2px dashed #93c5fd;outline-offset:2px}

  /* Pillï¼ˆLeader æŒ‰éˆ•ï¼‰ */
  .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid #2b3244;background:#0f1117;box-shadow:0 6px 16px rgba(0,0,0,.35);cursor:grab;user-select:none}
  .pill .name{font-weight:900;font-size:13px;max-width:180px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .pill .dot{width:8px;height:8px;border-radius:50%;background:#a1a1aa;display:inline-block}
  .pill .dot-btn{width:16px;height:16px;border-radius:50%;display:grid;place-items:center;border:1px solid #2b3244;background:#141824;cursor:pointer}
  .pill .dot-btn:hover{box-shadow:0 0 0 1px rgba(255,255,255,.15)}

  /* ===== 11Ã—11 Grid ===== */
  .grid-wrap{margin-top:14px}
  .grid{display:grid;grid-template-columns:repeat(11,var(--colw));gap:10px;align-items:start}
  .cell{border:1px solid var(--border);border-radius:12px;background:#10131A;padding:8px;display:flex;flex-direction:column;gap:8px}
  .table-name{width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#0f1117;color:#e5e7eb;font-size:13px}
  .drop{min-height:40px;border:2px dashed #2b3244;border-radius:10px;display:grid;place-items:center;padding:6px}
  .drop.drop-hover{outline:2px dashed #93c5fd;outline-offset:2px}
  .cell .placeholder{font-size:12px;color:#6b7280}

  /* ===== Popover ===== */
  .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50}
  .popover{width:min(560px,92vw);max-height:70vh;overflow:auto;background:#0f1117;border:1px solid #2b3244;border-radius:14px;box-shadow:0 20px 60px rgba(0,0,0,.5);padding:12px}
  .po-head{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .po-title{font-weight:900}
  .po-list{margin-top:8px;display:flex;flex-direction:column;gap:6px}
  .po-item{display:flex;align-items:center;gap:8px;border:1px solid #2b3244;border-radius:10px;padding:6px 8px;background:#10131A}
  .po-item .nm{font-weight:800}
  .po-item .ig{font-size:12px;color:#9AA4AF;margin-left:auto}

  .toast{position:fixed;left:50%;bottom:14px;transform:translateX(-50%);background:#0f1117;border:1px solid #2b3244;color:#e5e7eb;padding:8px 12px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.45);opacity:0;transition:opacity .25s;z-index:60}
  .toast.show{opacity:1}

  .ctrls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .ctrls label{font-size:12px;color:var(--muted)}
  .ctrls input[type="range"]{width:180px}
  .hint{font-size:12px;color:var(--muted)}

  .rb{height:2px;background:var(--rainbow);opacity:.6;border-radius:2px;margin:6px 0 10px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="h">11Ã—11 æ’æ¡Œè¡¨ï½œLeader Dock + Popover</div>
    <div class="sub">è³‡æ–™ç›´æ¥è®€å–é›²ç«¯ rosterï¼›åƒ…ã€Œå„²å­˜ã€æ™‚å‘¼å« GAS å›å¡« numberã€‚</div>
    <div class="rb"></div>

    <!-- Top controls -->
    <div class="bar">
      <div class="ctrls">
        <label for="colw">æ¬„å¯¬</label>
        <input id="colw" type="range" min="30" max="250" step="1" value="100" />
        <span id="colwVal" class="hint">100px</span>
        <button id="btnAuto" class="btn">è‡ªå‹•æ’åˆ—ï¼ˆä¾ Leader åç¨±ï¼‰</button>
        <button id="btnMode" class="btn toggle" aria-pressed="false" title="è¦†è“‹ / äº¤æ›">è¦†è“‹æ¨¡å¼</button>
      </div>
      <div class="ctrls">
        <button id="btnSave" class="btn primary">å„²å­˜ï¼ˆå›å¡« numberï¼‰</button>
      </div>
    </div>

    <!-- Leader Dock -->
    <section class="dock" aria-label="Leader Dock" id="dock">
      <div class="dock-title">
        <div class="h" style="font-size:16px">Leaders</div>
        <div class="sub" id="dockCount">0 ä½</div>
      </div>
      <div class="dock-body" id="dockBody" data-dropzone="dock">
        <div class="placeholder">å°‡ Leader æ‹–æ›³åˆ°ä»»ä¸€æ¡Œæ ¼ï¼Œæˆ–æ‹–å›æ­¤ Dockã€‚</div>
      </div>
    </section>

    <!-- Grid -->
    <div class="grid-wrap">
      <div class="grid" id="grid"></div>
    </div>
  </div>

  <!-- Popover -->
  <div class="backdrop" id="poBack">
    <div class="popover" role="dialog" aria-modal="true">
      <div class="po-head">
        <div class="po-title" id="poTitle">æˆå“¡æ¸…å–®</div>
        <button class="btn" id="poClose">é—œé–‰</button>
      </div>
      <div class="rb"></div>
      <div id="poList" class="po-list"></div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
/* =====================
   (1) è¨­å®šå€
   ===================== */
// 1) é›²ç«¯åå–®ï¼ˆèˆ‡ GAS ç„¡é—œï¼‰ï¼šéœ€å›å‚³ Array<Row>
//    Row æ¬„ä½ï¼š{ item, number, name, ig, country, flag, leader, link, status }
const ROSTER_URL = 'https://docs.google.com/spreadsheets/d/1DY4TajQDdvikPfM_-A6St5CCW996NtQkclC2IG4PJ4s/gviz/tq?tqx=out:json&sheet=roster';

// 2) åƒ…åœ¨å„²å­˜æ™‚å‘¼å« GASï¼šå„ªå…ˆ bulkUpdateNumberï¼ˆä¸€æ¬¡å›å¡«ï¼‰ï¼Œfallback updateNumberï¼ˆé€ç­†ï¼‰
const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxXpx1URTdhPIwO1HcDdZb6uAI7zMJFynFV8TlGAA8Vi5ulDVFvh-uOatx4RUeiWHLBLw/exec';

// 3) å›ºå®š 11Ã—11
const ROWS = 11, COLS = 11, CELLS = ROWS * COLS;

/* =====================
   (2) ç‹€æ…‹
   ===================== */
const state = {
  rows: [],
  leaders: [],
  membersByLeader: new Map(),
  pos: new Map(),
  swapMode: false,
};

/* =====================
   (3) DOM å¿«æ·
   ===================== */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const toast = msg => { const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1800) };
const setColw = px => { document.documentElement.style.setProperty('--colw', px+'px'); $('#colwVal').textContent = px+'px'; };

/* =====================
   (4) åˆå§‹åŒ–
   ===================== */
(async function init(){
  $('#colw').addEventListener('input', e=> setColw(e.target.value));
  setColw($('#colw').value);
  $('#btnMode').addEventListener('click', ()=>{
    state.swapMode = !state.swapMode;
    const b = $('#btnMode');
    b.setAttribute('aria-pressed', state.swapMode?'true':'false');
    b.textContent = state.swapMode ? 'äº¤æ›æ¨¡å¼' : 'è¦†è“‹æ¨¡å¼';
  });
  $('#poBack').addEventListener('click', e=>{ if(e.target.id==='poBack') closePopover() });
  $('#poClose').addEventListener('click', closePopover);

  buildGrid();
  await loadRoster();
  buildDock();
})();

/* =====================
   (5) è®€å–é›²ç«¯ rosterï¼ˆé GASï¼‰
   ===================== */
async function loadRoster(){
  try{
    const res = await fetch(ROSTER_URL, { cache: 'no-store', mode:'cors' });
    if(!res.ok) throw new Error('Roster fetch failed');
    let text = await res.text();

    let rowsArr;
    // å…ˆè©¦ç´” JSON
    try {
      const j = JSON.parse(text);
      rowsArr = Array.isArray(j) ? j : (Array.isArray(j.rows) ? j.rows : null);
    } catch(_) {}

    // è§£æ gviz
    if(!Array.isArray(rowsArr)){
      const m = text.match(/setResponse\((.*)\);?$/s);
      if(!m) throw new Error('Invalid gviz payload (ç¢ºèªè©¦ç®—è¡¨ã€Œæ“æœ‰é€£çµè€…å¯æª¢è¦–ã€èˆ‡ sheet=roster)');
      const g = JSON.parse(m[1]);
      const cols = g.table.cols.map(c => (c.label || c.id || '').toString().trim().toLowerCase());
      rowsArr = g.table.rows.map(r => {
        const obj = {};
        (r.c||[]).forEach((cell, i) => {
          obj[cols[i] || ('col'+i)] = (cell && (cell.v ?? cell.f)) ?? '';
        });
        return obj;
      });
    }

    const needKeys = ['item','number','name','ig','country','flag','leader','link','status'];
    const normalized = rowsArr.map(r => {
      const o = {};
      for(const k of needKeys){
        const hit = Object.keys(r).find(x => x && x.trim().toLowerCase() === k);
        o[k] = (hit ? r[hit] : '') ?? '';
      }
      o.leader = (o.leader||'').toString().trim();
      o.name   = (o.name  ||'').toString().trim();
      o.ig     = (o.ig    ||'').toString().trim();
      return o;
    });

    const groups = new Map();
    for(const r of normalized){
      const key = (r.leader || '').trim();
      if(!groups.has(key)) groups.set(key, []);
      groups.get(key).push(r);
    }
    state.membersByLeader = groups;
    state.leaders = Array.from(groups.keys()).filter(x=>x).sort((a,b)=>a.localeCompare(b));
    state.pos.clear();
    for(const L of state.leaders){ state.pos.set(L, {type:'dock'}); }
    $('#dockCount').textContent = `${state.leaders.length} ä½`;
  }catch(err){
    console.error(err);
    toast('åå–®è¼‰å…¥å¤±æ•—ï¼ˆè¡¨å–®æ¬Šé™æˆ–åˆ†é åç¨±ï¼‰');
  }
}

/* =====================
   (6) Dock & Grid
   ===================== */
function buildDock(){
  const box = $('#dockBody');
  box.innerHTML = '';
  box.addEventListener('dragover', e=>{e.preventDefault(); box.classList.add('drop-hover')});
  box.addEventListener('dragleave', ()=> box.classList.remove('drop-hover'));
  box.addEventListener('drop', e=>{
    e.preventDefault(); box.classList.remove('drop-hover');
    const L = e.dataTransfer.getData('text/leader');
    if(!L) return;
    moveLeaderToDock(L);
  });

  const inDock = state.leaders.filter(L => (state.pos.get(L)||{}).type==='dock');
  if(!inDock.length){
    const p = document.createElement('div'); p.className='placeholder'; p.textContent='Dock ç›®å‰æ²’æœ‰ Leader'; box.appendChild(p);
  } else {
    for(const L of inDock){ box.appendChild(pill(L)); }
  }
}

function buildGrid(){
  const g = $('#grid'); g.innerHTML='';
  for(let i=0;i<CELLS;i++){
    const cell = document.createElement('div'); cell.className='cell'; cell.dataset.idx=i;
    const input = document.createElement('input'); input.type='text'; input.className='table-name'; input.placeholder='æ¡Œåï¼ˆèˆ‡æ¬„å¯¬åŒæ­¥ï¼‰';
    const drop = document.createElement('div'); drop.className='drop'; drop.dataset.dropzone='cell'; drop.innerHTML='<span class="placeholder">Leader æ”¾ç½®å€</span>';

    drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.classList.add('drop-hover') });
    drop.addEventListener('dragleave', ()=> drop.classList.remove('drop-hover'));
    drop.addEventListener('drop', e=>{
      e.preventDefault(); drop.classList.remove('drop-hover');
      const L = e.dataTransfer.getData('text/leader'); if(!L) return;
      placeLeaderIntoCell(L, i);
    });

    cell.append(input, drop);
    g.appendChild(cell);
  }
}

function pill(leader){
  const el = document.createElement('div'); el.className='pill'; el.draggable=true; el.dataset.leader=leader;
  el.addEventListener('dragstart', e=>{
    e.dataTransfer.setData('text/leader', leader);
    e.dataTransfer.effectAllowed = 'move';
  });
  const nm = document.createElement('span'); nm.className='name'; nm.textContent=leader;
  const dotBtn = document.createElement('button'); dotBtn.className='dot-btn'; dotBtn.title='æŸ¥çœ‹æˆå“¡ï¼ˆPopoverï¼‰';
  const dot = document.createElement('span'); dot.className='dot'; dotBtn.appendChild(dot);
  dotBtn.addEventListener('click', ()=> openPopover(leader));
  el.append(nm, dotBtn);
  return el;
}

function renderCellLeader(idx){
  const cell = document.querySelector(`.cell[data-idx="${idx}"]`);
  if(!cell) return;
  const drop = cell.querySelector('.drop');
  drop.innerHTML='';
  const leader = getLeaderAtCell(idx);
  if(!leader){ drop.innerHTML='<span class="placeholder">Leader æ”¾ç½®å€</span>'; return; }
  drop.appendChild(pill(leader));
}

function getLeaderAtCell(idx){
  for(const [L,pos] of state.pos){ if(pos.type==='cell' && pos.idx===idx) return L; }
  return null;
}

/* =====================
   (7) DnD è¡Œç‚º
   ===================== */
function moveLeaderToDock(leader){
  const pos = state.pos.get(leader); if(!pos) return;
  if(pos.type==='cell'){ renderCellLeader(pos.idx); }
  state.pos.set(leader, {type:'dock'});
  buildDock();
}

function placeLeaderIntoCell(leader, idx){
  const src = state.pos.get(leader);
  const occupied = getLeaderAtCell(idx);

  if(!occupied){
    if(src && src.type==='cell') renderCellLeader(src.idx);
    state.pos.set(leader, {type:'cell', idx});
    renderCellLeader(idx); buildDock();
    return;
  }
  if(occupied === leader){ return; }

  if(state.swapMode){
    const srcPos = src;
    state.pos.set(leader, {type:'cell', idx});
    if(srcPos && srcPos.type==='cell'){
      state.pos.set(occupied, {type:'cell', idx: srcPos.idx});
      renderCellLeader(srcPos.idx);
    }else{
      state.pos.set(occupied, {type:'dock'});
      buildDock();
    }
    renderCellLeader(idx);
  } else {
    const occPos = state.pos.get(occupied);
    state.pos.set(occupied, {type:'dock'});
    state.pos.set(leader, {type:'cell', idx});
    renderCellLeader(idx);
    if(occPos) buildDock();
    if(src && src.type==='cell') renderCellLeader(src.idx);
  }
}

/* =====================
   (8) Popover
   ===================== */
function openPopover(leader){
  const list = state.membersByLeader.get(leader)||[];
  $('#poTitle').textContent = `Leaderï¼š${leader}ï¼ˆ${list.length} äººï¼‰`;
  const box = $('#poList'); box.innerHTML='';
  for(const r of list){
    const row = document.createElement('div'); row.className='po-item';
    const flag = document.createElement('div'); flag.textContent = r.flag || 'â€”';
    const nm = document.createElement('div'); nm.className='nm'; nm.textContent = r.name||'â€”';
    const ig = document.createElement('div'); ig.className='ig'; ig.textContent = r.ig||'';
    row.append(flag,nm,ig); box.appendChild(row);
  }
  $('#poBack').style.display='flex';
}
function closePopover(){ $('#poBack').style.display='none'; }

/* =====================
   (9) è‡ªå‹•æ’åˆ—
   ===================== */
$('#btnAuto').addEventListener('click', ()=>{
  for(const L of state.leaders){ state.pos.set(L,{type:'dock'}); }
  buildDock();
  const sorted = [...state.leaders].sort((a,b)=>a.localeCompare(b));
  let k=0;
  for(let i=0;i<CELLS;i++){
    const L = sorted[k++]; if(!L) break;
    state.pos.set(L,{type:'cell', idx:i});
    renderCellLeader(i);
  }
  buildDock();
});

/* =====================
   (10) å„²å­˜å›å¡«
   ===================== */
$('#btnSave').addEventListener('click', saveAll);

async function saveAll(){
  if(!GAS_WEB_APP_URL || GAS_WEB_APP_URL.startsWith('<<')){
    toast('è«‹å…ˆè¨­å®š GAS_WEB_APP_URL'); return;
  }
  const payload = [];
  const countMap = new Map();
  for(const [L, arr] of state.membersByLeader){ if(!L) continue; countMap.set(L, arr.length); }

  const cells = $$('.cell');
  for(const cell of cells){
    const idx = parseInt(cell.dataset.idx,10);
    const tn = cell.querySelector('.table-name').value.trim();
    const L = getLeaderAtCell(idx);
    if(!tn || !L) continue;
    const count = countMap.get(L)||0;
    const value = `${tn}(${count})`;
    const members = state.membersByLeader.get(L)||[];
    for(const m of members){
      payload.push({ item:m.item, ig:m.ig, name:m.name, leader:L, number:value });
    }
  }
  if(!payload.length){ toast('æ²’æœ‰å¯å„²å­˜çš„æ ¼å­'); return; }

  const bulkBody = JSON.stringify({ action:'bulkUpdateNumber', changes: payload, sheet:'roster', ts:Date.now() });
  let ok = await tryPost(GAS_WEB_APP_URL, bulkBody);

  if(!ok){
    let all = true;
    for(const ch of payload){
      const body = JSON.stringify({ action:'updateNumber', item: ch.item, ig:ch.ig, name:ch.name, leader:ch.leader, number: ch.number, sheet:'roster', ts:Date.now() });
      const one = await tryPost(GAS_WEB_APP_URL, body);
      if(!one) all = false;
    }
    ok = all;
  }
  toast(ok ? 'å·²å›å¡« number' : 'å›å¡«å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
}

async function tryPost(url, body){
  try{
    const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body, mode:'cors', cache:'no-store' });
    if(res.type==='opaque') return true;
    if(res.ok) return true;
    try{ const j=await res.json(); return !!(j && (j.ok || Array.isArray(j))); }catch{ return false; }
  }catch{ return false; }
}
</script>
</body>
</html>
