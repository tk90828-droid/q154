<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Taiwan Pride 🌈｜Seating Planner｜11×11</title>
<style>
  :root{
    --bg:#0A0B0F; --card:#10131A; --muted:#9AA4AF; --fg:#F2F5F8; --border:#1f2430;
    --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    --rainbow: linear-gradient(90deg,#ff5f6d,#ffc371,#9be15d,#00e3ae,#45aaf2,#9b59b6);
    --btn-grad: linear-gradient(90deg,#7dd3fc,#86efac);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:"Noto Sans TC","PingFang TC","Microsoft JhengHei",ui-sans-serif,system-ui;
    background: radial-gradient(800px 600px at 10% -10%, rgba(255,255,255,.06), transparent), var(--bg);
    color:var(--fg);
  }
  a{color:inherit;text-decoration:none}
  .wrap{max-width:1180px;margin:28px auto 64px;padding:0 14px}

  .tl .t1,.tl .t2,.tl .t3{color:#fff;text-shadow:0 0 8px rgba(255,255,255,.28),0 0 18px rgba(255,255,255,.12)}
  .tl .t1{font-size:28px;font-weight:900;line-height:1.15}
  .tl .t2{font-size:22px;font-weight:800;opacity:.95}
  .tl .t3{font-size:16px;font-weight:700;opacity:.9}
  .rainbow-line{height:2px;background:var(--rainbow);opacity:.6;border-radius:2px;margin:6px 0 14px}

  .rbtext{
    background:var(--rainbow);
    -webkit-background-clip:text;background-clip:text;
    color:transparent;font-weight:900;letter-spacing:.2px;text-shadow:0 0 12px rgba(255,255,255,.08);
  }

  .toolbar{
    display:flex;gap:10px;align-items:center;flex-wrap:wrap;
    background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));
    border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:10px;
    box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.03);
  }
  .ctrl{display:flex;gap:8px;align-items:center}
  .ctrl label{font-size:12px;color:var(--muted)}
  .ctrl input[type="number"]{width:80px;padding:8px 10px;border-radius:12px;border:1px solid var(--border);background:#0f1117;color:var(--fg);font-size:14px}
  .ctrl button{padding:8px 12px;border-radius:12px;border:1px solid var(--border);background:#0f1117;color:#e5e7eb;cursor:pointer;font-size:13px}
  .ctrl .primary{background:var(--btn-grad);border:0;color:#0b0c10;font-weight:900;letter-spacing:.2px}

  /* Leader Dock */
  .leader-dock{
    display:flex;gap:10px;align-items:center;overflow:auto;padding:8px 2px;margin-top:10px
  }
  .leader-chip{
    position:relative; display:inline-flex; align-items:center; gap:10px;
    padding:10px 16px 10px 14px; border-radius:999px;
    background:#0f1117; border:1px solid #2b3244; cursor:grab; user-select:none;
    box-shadow:0 8px 20px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.03);
    font-weight:900; font-size:14px;
  }
  .leader-chip:active{cursor:grabbing; transform:scale(.98)}
  .leader-name{
    background:linear-gradient(90deg,#ff5f6d,#ffc371,#9be15d,#00e3ae,#45aaf2,#9b59b6);
    -webkit-background-clip:text;background-clip:text;color:transparent;
    letter-spacing:.2px; white-space:nowrap; max-width:200px; overflow:hidden; text-overflow:ellipsis;
  }
  .leader-dot{
    width:18px; height:18px; border-radius:50%;
    background:rgba(255,255,255,.06); border:1px solid #2b3244; flex:0 0 auto;
    position:relative;
  }
  .leader-dot::after{
    content:""; position:absolute; inset:3px; border-radius:50%;
    background:conic-gradient(#ff5f6d,#ffc371,#9be15d,#00e3ae,#45aaf2,#9b59b6,#ff5f6d);
    filter:blur(1px); opacity:.9;
  }
  .leader-chip .mini{
    font-size:11px; color:#aeb7c2; font-weight:800; margin-left:2px
  }

  /* Popover */
  .popover{
    position:fixed; z-index:60; min-width:220px; max-width:280px;
    background:#0f1117; border:1px solid #2b3244; border-radius:12px; padding:8px;
    box-shadow:0 20px 60px rgba(0,0,0,.5); display:none;
  }
  .pop-title{font-weight:900; font-size:13px; margin-bottom:6px}
  .pop-list{display:flex; flex-direction:column; gap:6px; max-height:48vh; overflow:auto}
  .pop-row{display:flex; align-items:center; gap:6px; padding:6px; border-radius:8px; background:rgba(255,255,255,.02); border:1px dashed #2b3244}
  .pop-row .flag{font-size:14px}
  .pop-row .name{font-size:12px; color:#E5E7EB; font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

  /* Seat Grid */
  .stage{
    margin-top:12px; display:grid; grid-template-columns:280px 1fr; gap:12px; align-items:start;
  }
  .legend-card{
    background:#10131A; border:1px solid #2b3244; border-radius:12px; padding:10px;
    position:sticky; top:12px;
  }
  .legend-title{font-weight:900; font-size:14px; margin-bottom:10px}
  .legend-tip{font-size:12px; color:#9aa4af; line-height:1.5}
  .panel{
    background:#10131A; border:1px solid #2b3244; border-radius:12px;
    padding:10px; overflow:auto;
  }
  .grid{
    --cell:100px;
    display:grid; grid-template-columns:repeat(11, var(--cell)); gap:10px; width:max-content;
  }
  .seat{
    background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));
    border:1px solid #2b3244; border-radius:12px; padding:8px; min-height:120px;
    display:flex; flex-direction:column; gap:8px; position:relative;
    box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.03);
  }
  .seat.drag-hover{ outline:2px dashed #93c5fd; outline-offset:3px }
  .seat-top{display:flex; align-items:center; gap:6px}
  .seat-top input{
    width:100%; padding:8px 10px; border-radius:10px; border:1px solid var(--border);
    background:#0f1117; color:#e5e7eb; font-size:13px; outline:none;
  }
  .seat-num{font-size:11px;color:#9aa4af}
  .seat-body{display:flex; flex-direction:column; gap:6px}
  .seat-chip{
    display:flex; align-items:center; gap:6px; padding:6px; border-radius:8px;
    border:1px dashed #2b3244; background:rgba(255,255,255,.02); font-size:12px; font-weight:800;
  }
  .seat-chip .flag{font-size:12px}
  .pending-bar{
    margin-top:12px; display:flex; align-items:center; justify-content:space-between; gap:10px;
    background:#0f1117; border:1px dashed #2b3244; border-radius:12px; padding:8px 10px;
  }
  .pending-bar .info{font-size:12px; color:#9aa4af}
  .pending-bar .btn{padding:8px 10px; border-radius:10px; border:1px solid #2b3244; background:#0f1117; color:#e5e7eb; font-weight:800; cursor:pointer}
  .pending-bar .btn.primary{border:0; background:var(--btn-grad); color:#0b0c10}

  .toast{position:fixed;left:50%;bottom:14px;transform:translateX(-50%);background:#0f1117;border:1px solid #2b3244;color:#e5e7eb;padding:8px 12px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.45);opacity:0;transition:opacity .25s;z-index:90}
  .toast.show{opacity:1}
</style>
</head>
<body>
  <div class="wrap">
    <div class="title tl">
      <div class="t1">Taiwan Pride 🌈</div>
      <div class="t2">Seating Planner</div>
      <div class="t3">11×11 Grid • Drag Leaders to Tables</div>
    </div>
    <div class="rainbow-line"></div>

    <!-- 工具列 -->
    <div class="toolbar">
      <div class="ctrl">
        <label>格寬(px)</label>
        <input id="cellWidth" type="number" min="30" max="150" step="2" value="100">
        <button id="applyCell" class="primary">套用</button>
      </div>
      <div class="ctrl">
        <button id="saveBtn" class="primary">Save 變更</button>
        <button id="reloadBtn">重新載入名單</button>
      </div>
      <div class="ctrl" style="margin-left:auto">
        <span style="font-size:12px;color:#9aa4af">將 Leader 拖曳到「已設定桌號」的格子上即可分配全員</span>
      </div>
    </div>

    <!-- Leader Dock -->
    <div class="leader-dock" id="leaderDock" aria-label="leaders"></div>

    <!-- 佈署區 -->
    <div class="stage">
      <div class="legend-card">
        <div class="legend-title">說明</div>
        <div class="legend-tip">
          1) 請先在桌位上方輸入桌號（或桌名），<b>此值將回填到 number 欄</b>。<br>
          2) 將上方 Leader（橢圓按鈕）拖到桌上，<b>該 Leader 全體成員</b>的 number 都會被指定為此桌號。<br>
          3) 右上可調整格寬（30–150px）。<br>
          4) 點 Leader 右側小圓圈，可開啟懸浮視窗查看該組成員名單。
        </div>
        <div class="pending-bar" id="pendingBar" style="display:none">
          <div class="info"><span id="pendingCount">0</span> 筆待儲存變更</div>
          <div>
            <button id="cancelPending" class="btn">清除</button>
            <button id="savePending" class="btn primary">Save 變更</button>
          </div>
        </div>
      </div>

      <div class="panel">
        <div id="grid" class="grid"></div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>
  <div id="popover" class="popover" role="dialog" aria-modal="true"></div>

<script>
/* ====== 設定（請改成你的 GAS） ====== */
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwtVm9gRHXeekRTh9SjXVAuJePChIckRpwtkrndpoyKldWWVzHqPjQ2yxLBY0av4uJezw/exec';

/* ====== 狀態 ====== */
const state = {
  rows: [],              // roster
  leaders: [],           // unique leaders [{name, count}]
  seatNumbers: {},       // seatId -> tableNumber (輸入框值)
  pending: new Map(),    // item -> newNumber（待儲存）
};

/* ====== 工具 ====== */
const $ = (id)=>document.getElementById(id);
const showToast = (msg)=>{ const t=$('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1400) };
const norm = (s)=> (s||'').toString().trim().toLowerCase();

/* ====== 載入名單 ====== */
async function fetchRoster(){
  try{
    const res = await fetch(WEB_APP_URL + '?mode=roster', { method:'GET', cache:'no-store' });
    const data = await res.json();
    state.rows = Array.isArray(data) ? data : (data.rows || []);
    buildLeaders();
    buildLeaderDock();
    buildGrid();
    updatePendingBar();
  }catch(e){
    console.error(e); showToast('名單載入失敗');
  }
}

/* 取出 leaders */
function buildLeaders(){
  const m = new Map();
  for(const r of state.rows){
    const key = (r.leader||'').trim() || '—';
    m.set(key, (m.get(key)||0)+1);
  }
  state.leaders = [...m.entries()].map(([name,count])=>({name,count})).sort((a,b)=> a.name.localeCompare(b.name));
}

/* ====== Leader Dock（橢圓＋資訊點） ====== */
function buildLeaderDock(){
  const dock = $('leaderDock');
  dock.innerHTML='';
  for(const L of state.leaders){
    const chip = document.createElement('div');
    chip.className='leader-chip';
    chip.draggable = true;
    chip.dataset.leader = L.name;
    chip.addEventListener('dragstart', (e)=>{
      e.dataTransfer.setData('text/plain', JSON.stringify({ leader: L.name }));
    });

    const name = document.createElement('div');
    name.className='leader-name';
    name.textContent = L.name || '—';

    const mini = document.createElement('span');
    mini.className='mini';
    mini.textContent = `(${L.count})`;

    const dot = document.createElement('div');
    dot.className='leader-dot';
    dot.title='查看成員';
    dot.addEventListener('click',(ev)=>{
      ev.stopPropagation();
      openPopoverForLeader(L.name, ev);
    });

    chip.append(name, mini, dot);
    dock.appendChild(chip);
  }
}

/* ====== 成員 Popover ====== */
function openPopoverForLeader(leader, ev){
  const pop = $('popover');
  const members = state.rows.filter(r=> norm(r.leader)===norm(leader));
  pop.innerHTML='';
  const title = document.createElement('div'); title.className='pop-title';
  title.innerHTML = `Leader：<span class="rbtext">${leader||'—'}</span>（${members.length}）`;
  const list = document.createElement('div'); list.className='pop-list';
  members.forEach(m=>{
    const row = document.createElement('div'); row.className='pop-row';
    const flag=document.createElement('div'); flag.className='flag'; flag.textContent=m.flag||'—';
    const name=document.createElement('div'); name.className='name'; name.textContent=m.name||'—';
    list.appendChild(Object.assign(row,{appendChild:(c)=>{row.append(flag,name); return row}}));
    row.append(flag, name);
  });
  pop.append(title, list);
  // 位置
  const rect = ev.currentTarget.getBoundingClientRect();
  pop.style.left = Math.min(window.innerWidth-300, Math.max(10, rect.right+8))+'px';
  pop.style.top = Math.min(window.innerHeight-200, Math.max(10, rect.top-10))+'px';
  pop.style.display='block';
}
document.addEventListener('click',(e)=>{
  const pop=$('popover');
  if(pop.style.display==='block' && !pop.contains(e.target)) pop.style.display='none';
});

/* ====== 11×11 Grid ====== */
function buildGrid(){
  const grid = $('grid');
  grid.style.setProperty('--cell', ($('cellWidth').value||'100')+'px');
  grid.innerHTML='';
  // 121 seats
  for(let i=0;i<121;i++){
    const seatId = `S${i+1}`; // S1..S121
    const seat = document.createElement('div'); seat.className='seat'; seat.dataset.seatId = seatId;

    // Drop 行為
    seat.addEventListener('dragover',(e)=>{ e.preventDefault(); seat.classList.add('drag-hover'); });
    seat.addEventListener('dragleave',()=> seat.classList.remove('drag-hover'));
    seat.addEventListener('drop',(e)=>{
      e.preventDefault(); seat.classList.remove('drag-hover');
      const payload = JSON.parse(e.dataTransfer.getData('text/plain')||'{}');
      if(!payload || !payload.leader){ return; }
      const number = (seat.querySelector('input').value||'').trim();
      if(!number){ showToast('請先輸入此桌的桌號/桌名'); return; }
      assignLeaderToSeat(payload.leader, number, seat);
    });

    // seat top
    const top = document.createElement('div'); top.className='seat-top';
    const input = document.createElement('input');
    input.placeholder = `輸入桌名／桌號`;
    input.value = state.seatNumbers[seatId] || '';
    input.addEventListener('change',()=>{
      state.seatNumbers[seatId] = input.value.trim();
      // 更新 Seat 標籤
      num.textContent = input.value.trim() ? `#${input.value.trim()}` : '';
    });
    const num = document.createElement('div'); num.className='seat-num';
    num.textContent = input.value ? `#${input.value}` : '';
    top.append(input, num);

    // body
    const body = document.createElement('div'); body.className='seat-body';

    seat.append(top, body);
    grid.appendChild(seat);
  }
}

/* 將 Leader 指派到座位（把 Leader 全員的 number 設定為該座位的桌號） */
function assignLeaderToSeat(leader, tableNumber, seatEl){
  const members = state.rows.filter(r=> norm(r.leader)===norm(leader));
  if(!members.length){ showToast('此 Leader 無成員'); return; }

  // 標記 pending（以 item 為唯一鍵）
  for(const m of members){
    const item = (m.item||'').toString();
    if(!item) continue;
    state.pending.set(item, tableNumber);
  }

  // 座位內展示（簡短 chip）
  const body = seatEl.querySelector('.seat-body');
  body.innerHTML='';
  const chip = document.createElement('div'); chip.className='seat-chip';
  chip.innerHTML = `<span class="flag">👑</span><span>${leader}</span><span style="font-size:11px;color:#9aa4af">（${members.length}）</span>`;
  body.appendChild(chip);

  updatePendingBar();
  showToast(`已指派：${leader} → #${tableNumber}（${members.length} 人）`);
}

/* ====== 待儲存列 ====== */
function updatePendingBar(){
  const bar = $('pendingBar');
  const n = state.pending.size;
  $('pendingCount').textContent = n;
  bar.style.display = n>0 ? 'flex':'none';
}
$('cancelPending').addEventListener('click', ()=>{
  state.pending.clear();
  updatePendingBar();
  showToast('已清除待儲存變更');
});
$('savePending').addEventListener('click', saveChanges);
$('saveBtn').addEventListener('click', saveChanges);

/* ====== 儲存（多種 fallback 以相容你的 GAS） ====== */
async function fetchMaybeOk(url, init){
  try{
    const res = await fetch(url, init);
    if(res.type==='opaque') return true;
    if(res.ok) return true;
    try{ const j = await res.json(); return !!(j && (j.ok || Array.isArray(j))); }catch(_){}
    return false;
  }catch(_){ return false; }
}

async function saveChanges(){
  if(state.pending.size===0){ showToast('沒有變更'); return; }
  const updates = [];
  for(const [item, number] of state.pending.entries()){
    updates.push({ item, number });
  }

  // 1) 盡量用 bulk
  let ok = await fetchMaybeOk(WEB_APP_URL, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ action:'bulkUpdateNumber', sheet:'roster', updates, ts:Date.now() }),
    mode:'cors', cache:'no-store'
  });

  // 2) fallback: text/plain
  if(!ok) ok = await fetchMaybeOk(WEB_APP_URL, {
    method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'},
    body: JSON.stringify({ action:'bulkUpdateNumber', sheet:'roster', updates, ts:Date.now() }),
    mode:'cors', cache:'no-store'
  });

  // 3) fallback: 分批逐筆 updateNumber
  if(!ok){
    ok = true;
    for(const u of updates){
      const one = await fetchMaybeOk(WEB_APP_URL, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ action:'updateNumber', sheet:'roster', item:u.item, number:u.number, ts:Date.now() }),
        mode:'cors', cache:'no-store'
      });
      if(!one){ ok=false; break; }
    }
  }

  if(!ok){ showToast('儲存失敗'); return; }

  // 更新本地 rows
  for(const u of updates){
    const row = state.rows.find(r=> (r.item||'').toString()===u.item);
    if(row) row.number = u.number;
  }
  state.pending.clear();
  updatePendingBar();
  showToast('已儲存變更');
}

/* ====== 事件：格寬調整與重載 ====== */
$('applyCell').addEventListener('click', ()=>{
  const v = clamp(parseInt($('cellWidth').value||'100',10), 30, 150);
  $('cellWidth').value = String(v);
  $('grid').style.setProperty('--cell', v+'px');
});
$('reloadBtn').addEventListener('click', fetchRoster);
function clamp(n, lo, hi){ return Math.max(lo, Math.min(hi, n)); }

/* ====== 啟動 ====== */
fetchRoster();
</script>
</body>
</html>
